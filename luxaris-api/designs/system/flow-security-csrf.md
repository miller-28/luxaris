# CSRF (Cross-Site Request Forgery) Protection Flow

## Overview
This document describes the data flow and protection mechanisms against CSRF attacks in the Luxaris API.

## CSRF Attack Scenario (Cookie-Based Auth)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CSRF Attack Scenario                       â”‚
â”‚              (If using cookie-based authentication)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Browser         Malicious Site       Luxaris API           Database
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚  1. User logged in  â”‚                    â”‚                    â”‚
    â”‚     to Luxaris      â”‚                    â”‚                    â”‚
    â”‚  (has session       â”‚                    â”‚                    â”‚
    â”‚   cookie)           â”‚                    â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚  2. User visits     â”‚                    â”‚                    â”‚
    â”‚     evil.com        â”‚                    â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚  3. Page loads with â”‚                    â”‚                    â”‚
    â”‚     hidden form:    â”‚                    â”‚                    â”‚
    â”‚     <form action=   â”‚                    â”‚                    â”‚
    â”‚      "luxaris.com/  â”‚                    â”‚                    â”‚
    â”‚       delete-post"> â”‚                    â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚  4. Auto-submit     â”‚                    â”‚                    â”‚
    â”‚     POST request    â”‚                    â”‚                    â”‚
    â”‚     (browser auto-  â”‚                    â”‚                    â”‚
    â”‚      sends cookie!) â”‚                    â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚     Cookie: session=abc123               â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚                     â”‚  âŒ VULNERABLE:    â”‚                    â”‚
    â”‚                     â”‚  Valid session     â”‚                    â”‚
    â”‚                     â”‚  cookie accepted   â”‚                    â”‚
    â”‚                     â”‚                    â”‚  Delete Post       â”‚
    â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                     â”‚                    â”‚  DELETE FROM posts â”‚
    â”‚                     â”‚                    â”‚  WHERE id = X      â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚                     â”‚                    â”‚  ğŸš¨ ATTACK SUCCESS â”‚
    â”‚                     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  200 OK (Deleted!)  â”‚                    â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
```

## Current Protection: Authorization Header

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Current Implementation (Authorization Header)          â”‚
â”‚                      Natural CSRF Protection                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Browser         Malicious Site       Luxaris API           Database
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚  User logged in     â”‚                    â”‚                    â”‚
    â”‚  JWT stored in      â”‚                    â”‚                    â”‚
    â”‚  localStorage       â”‚                    â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚  Visits evil.com    â”‚                    â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚  Malicious form     â”‚                    â”‚                    â”‚
    â”‚  auto-submits       â”‚                    â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚     POST /api/v1/posts/123               â”‚                    â”‚
    â”‚     (NO Authorization header!)           â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚                     â”‚  JWT Middleware    â”‚                    â”‚
    â”‚                     â”‚  Checks for JWT    â”‚                    â”‚
    â”‚                     â”‚  in Authorization  â”‚                    â”‚
    â”‚                     â”‚  header            â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚                     â”‚  âŒ Not found      â”‚                    â”‚
    â”‚  401 Unauthorized   â”‚                    â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚  {                  â”‚                    â”‚                    â”‚
    â”‚    errors: [{       â”‚                    â”‚                    â”‚
    â”‚      error_code: "UNAUTHORIZED"          â”‚                    â”‚
    â”‚    }]               â”‚                    â”‚                    â”‚
    â”‚  }                  â”‚                    â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
    â”‚  ğŸ›¡ï¸ PROTECTED: Malicious site CANNOT     â”‚                    â”‚
    â”‚     add Authorization header to          â”‚                    â”‚
    â”‚     cross-origin requests                â”‚                    â”‚
    â”‚                     â”‚                    â”‚                    â”‚
```

## Legitimate Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Legitimate Request Flow                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dashboard (React)      Luxaris API           Database
    â”‚                     â”‚                     â”‚
    â”‚  User action:       â”‚                     â”‚
    â”‚  Delete Post        â”‚                     â”‚
    â”‚                     â”‚                     â”‚
    â”‚  1. Get JWT from    â”‚                     â”‚
    â”‚     localStorage    â”‚                     â”‚
    â”‚  token = "eyJ..."   â”‚                     â”‚
    â”‚                     â”‚                     â”‚
    â”‚  2. Make API call   â”‚                     â”‚
    â”‚     with header     â”‚                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚
    â”‚  DELETE /posts/123  â”‚                     â”‚
    â”‚  Authorization:     â”‚                     â”‚
    â”‚   Bearer eyJ...     â”‚                     â”‚
    â”‚                     â”‚                     â”‚
    â”‚                     â”‚  JWT Middleware     â”‚
    â”‚                     â”‚  1. Extract token   â”‚
    â”‚                     â”‚  2. Verify signatureâ”‚
    â”‚                     â”‚  3. Check expiry    â”‚
    â”‚                     â”‚  4. Extract user_id â”‚
    â”‚                     â”‚  âœ… Valid           â”‚
    â”‚                     â”‚                     â”‚
    â”‚                     â”‚  Auth Middleware    â”‚
    â”‚                     â”‚  Check permissions  â”‚
    â”‚                     â”‚  âœ… Authorized      â”‚
    â”‚                     â”‚                     â”‚
    â”‚                     â”‚  Execute Delete     â”‚
    â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                     â”‚  DELETE FROM posts  â”‚
    â”‚                     â”‚  WHERE id = $1      â”‚
    â”‚                     â”‚  AND user_id = $2   â”‚
    â”‚                     â”‚                     â”‚
    â”‚                     â”‚  Success            â”‚
    â”‚  200 OK             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
    â”‚                     â”‚                     â”‚
```

## Enhanced Protection: Origin Validation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Additional Layer: Origin Validation                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client                Origin Middleware      JWT Middleware       Handler
  â”‚                         â”‚                     â”‚                  â”‚
  â”‚  POST /api/v1/posts     â”‚                     â”‚                  â”‚
  â”‚  Origin: https://evil.com                     â”‚                  â”‚
  â”‚  Authorization: Bearer token                  â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                  â”‚
  â”‚                         â”‚  Check Origin       â”‚                  â”‚
  â”‚                         â”‚  header             â”‚                  â”‚
  â”‚                         â”‚                     â”‚                  â”‚
  â”‚                         â”‚  Allowed origins:   â”‚                  â”‚
  â”‚                         â”‚  - luxaris.com      â”‚                  â”‚
  â”‚                         â”‚  - dashboard.luxarisâ”‚                  â”‚
  â”‚                         â”‚  - localhost:3000   â”‚                  â”‚
  â”‚                         â”‚                     â”‚                  â”‚
  â”‚                         â”‚  âŒ Origin mismatch â”‚                  â”‚
  â”‚  403 Forbidden          â”‚                     â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                  â”‚
  â”‚  {                      â”‚                     â”‚                  â”‚
  â”‚    errors: [{           â”‚                     â”‚                  â”‚
  â”‚      error_code: "INVALID_ORIGIN"             â”‚                  â”‚
  â”‚    }]                   â”‚                     â”‚                  â”‚
  â”‚  }                      â”‚                     â”‚                  â”‚
  â”‚                         â”‚                     â”‚                  â”‚
  â”‚  ğŸ›¡ï¸ BLOCKED: Even with valid JWT,             â”‚                  â”‚
  â”‚              wrong origin rejected            â”‚                  â”‚
  â”‚                         â”‚                     â”‚                  â”‚
```

## Cookie-Based Auth with CSRF Token (Alternative)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Cookie-Based Auth + CSRF Token Protection               â”‚
â”‚                     (Alternative Implementation)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dashboard              Luxaris API               Database
    â”‚                     â”‚                          â”‚
    â”‚  1. Login Request   â”‚                          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
    â”‚  POST /auth/login   â”‚                          â”‚
    â”‚  { email, password }â”‚                          â”‚
    â”‚                     â”‚                          â”‚
    â”‚                     â”‚  Validate Credentials    â”‚
    â”‚                     â”‚                          â”‚
    â”‚                     â”‚  Generate Tokens:        â”‚
    â”‚                     â”‚  - JWT (session)         â”‚
    â”‚                     â”‚  - CSRF token (random)   â”‚
    â”‚                     â”‚                          â”‚
    â”‚  Set-Cookie:        â”‚                          â”‚
    â”‚   session_token=JWT â”‚                          â”‚
    â”‚   (HttpOnly, Secure,â”‚                          â”‚
    â”‚    SameSite=Strict) â”‚                          â”‚
    â”‚                     â”‚                          â”‚
    â”‚  Response Body:     â”‚                          â”‚
    â”‚   { csrf_token: "xxx" }                        â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
    â”‚                     â”‚                          â”‚
    â”‚  2. Store CSRF tokenâ”‚                          â”‚
    â”‚     in memory/state â”‚                          â”‚
    â”‚                     â”‚                          â”‚
    â”‚  3. Subsequent      â”‚                          â”‚
    â”‚     Request         â”‚                          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
    â”‚  POST /api/v1/posts â”‚                          â”‚
    â”‚  Cookie: session=JWTâ”‚                          â”‚
    â”‚  X-CSRF-Token: xxx  â”‚                          â”‚
    â”‚                     â”‚                          â”‚
    â”‚                     â”‚  CSRF Middleware         â”‚
    â”‚                     â”‚  1. Get cookie           â”‚
    â”‚                     â”‚  2. Get CSRF header      â”‚
    â”‚                     â”‚  3. Validate match       â”‚
    â”‚                     â”‚  âœ… Valid                â”‚
    â”‚                     â”‚                          â”‚
    â”‚                     â”‚  JWT Middleware          â”‚
    â”‚                     â”‚  âœ… Valid                â”‚
    â”‚                     â”‚                          â”‚
    â”‚                     â”‚  Process Request         â”‚
    â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚  201 Created        â”‚                          â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
    â”‚                     â”‚                          â”‚
```

## CSRF Attack Blocked (Cookie + CSRF Token)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Attack Blocked by CSRF Token Validation               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Browser         Malicious Site       Luxaris API
    â”‚                     â”‚                    â”‚
    â”‚  Has session cookie â”‚                    â”‚
    â”‚  (auto-sent by      â”‚                    â”‚
    â”‚   browser)          â”‚                    â”‚
    â”‚                     â”‚                    â”‚
    â”‚  Visits evil.com    â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                     â”‚                    â”‚
    â”‚  Malicious form     â”‚                    â”‚
    â”‚  submits            â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚  POST /api/v1/posts                      â”‚
    â”‚  Cookie: session=JWT (auto-sent)         â”‚
    â”‚  X-CSRF-Token: ??? (NOT AVAILABLE)       â”‚
    â”‚                     â”‚                    â”‚
    â”‚                     â”‚  CSRF Middleware   â”‚
    â”‚                     â”‚  1. Cookie present âœ…â”‚
    â”‚                     â”‚  2. CSRF token?    â”‚
    â”‚                     â”‚     âŒ Missing or  â”‚
    â”‚                     â”‚        invalid     â”‚
    â”‚                     â”‚                    â”‚
    â”‚  403 Forbidden      â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  {                  â”‚                    â”‚
    â”‚    errors: [{       â”‚                    â”‚
    â”‚      error_code: "CSRF_TOKEN_INVALID"    â”‚
    â”‚    }]               â”‚                    â”‚
    â”‚  }                  â”‚                    â”‚
    â”‚                     â”‚                    â”‚
    â”‚  ğŸ›¡ï¸ PROTECTED: Attacker cannot access    â”‚
    â”‚                 CSRF token (only in      â”‚
    â”‚                 memory/state of legit    â”‚
    â”‚                 dashboard)               â”‚
    â”‚                     â”‚                    â”‚
```

## SameSite Cookie Protection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SameSite Cookie Attribute                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Setting: SameSite=Strict

User Browser         Malicious Site       Luxaris API
    â”‚                     â”‚                    â”‚
    â”‚  Logged into        â”‚                    â”‚
    â”‚  luxaris.com        â”‚                    â”‚
    â”‚  Cookie set with:   â”‚                    â”‚
    â”‚  SameSite=Strict    â”‚                    â”‚
    â”‚                     â”‚                    â”‚
    â”‚  Visits evil.com    â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                     â”‚                    â”‚
    â”‚  <form> submits to  â”‚                    â”‚
    â”‚  luxaris.com        â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚  POST /api/v1/posts                      â”‚
    â”‚  Cookie: (NOT SENT) âŒ                   â”‚
    â”‚                     â”‚                    â”‚
    â”‚                     â”‚  ğŸ›¡ï¸ Browser blocks â”‚
    â”‚                     â”‚     cookie due to  â”‚
    â”‚                     â”‚     SameSite=Strictâ”‚
    â”‚                     â”‚                    â”‚
    â”‚  401 Unauthorized   â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                     â”‚                    â”‚


Setting: SameSite=Lax (Less Strict)

User Browser         Malicious Site       Luxaris API
    â”‚                     â”‚                    â”‚
    â”‚  Cookie set with:   â”‚                    â”‚
    â”‚  SameSite=Lax       â”‚                    â”‚
    â”‚                     â”‚                    â”‚
    â”‚  Clicks link on     â”‚                    â”‚
    â”‚  evil.com to        â”‚                    â”‚
    â”‚  luxaris.com        â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚  GET /posts (cookie sent âœ…)             â”‚
    â”‚                     â”‚                    â”‚
    â”‚  <form> POST from   â”‚                    â”‚
    â”‚  evil.com           â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚  POST /posts (cookie NOT sent âŒ)        â”‚
    â”‚                     â”‚                    â”‚
    â”‚  ğŸ›¡ï¸ Lax: Allows cookies on safe          â”‚
    â”‚      navigation (GET) but blocks         â”‚
    â”‚      on POST from other sites            â”‚
    â”‚                     â”‚                    â”‚
```

## Security Headers Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Security Headers                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client                Security Middleware      Response
  â”‚                         â”‚                      â”‚
  â”‚  Any API Request        â”‚                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
  â”‚                         â”‚  Add Headers:        â”‚
  â”‚                         â”‚                      â”‚
  â”‚                         â”‚  X-Frame-Options:    â”‚
  â”‚                         â”‚    DENY              â”‚
  â”‚                         â”‚  (Prevent iframe     â”‚
  â”‚                         â”‚   embedding)         â”‚
  â”‚                         â”‚                      â”‚
  â”‚                         â”‚  X-Content-Type:     â”‚
  â”‚                         â”‚    nosniff           â”‚
  â”‚                         â”‚  (Prevent MIME       â”‚
  â”‚                         â”‚   sniffing)          â”‚
  â”‚                         â”‚                      â”‚
  â”‚                         â”‚  Referrer-Policy:    â”‚
  â”‚                         â”‚    strict-origin     â”‚
  â”‚                         â”‚                      â”‚
  â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚  Response with headers  â”‚                      â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                      â”‚
  â”‚  ğŸ›¡ï¸ Headers help browser enforce security      â”‚
  â”‚                         â”‚                      â”‚
```

## Monitoring & Detection Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CSRF Attempt Detection                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Request               Origin Check         Logger              Alert
  â”‚                       â”‚                   â”‚                  â”‚
  â”‚  POST /api/v1/posts   â”‚                   â”‚                  â”‚
  â”‚  Origin: evil.com     â”‚                   â”‚                  â”‚
  â”‚  Valid JWT            â”‚                   â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                  â”‚
  â”‚                       â”‚  âŒ Invalid Originâ”‚                  â”‚
  â”‚                       â”‚                   â”‚                  â”‚
  â”‚                       â”‚  Log Attempt      â”‚                  â”‚
  â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
  â”‚                       â”‚  {                â”‚                  â”‚
  â”‚                       â”‚    event: "csrf_attempt",            â”‚
  â”‚                       â”‚    origin: "evil.com",               â”‚
  â”‚                       â”‚    endpoint: "/posts",               â”‚
  â”‚                       â”‚    user_id: "123",                   â”‚
  â”‚                       â”‚    ip: "1.2.3.4"                     â”‚
  â”‚                       â”‚  }                â”‚                  â”‚
  â”‚                       â”‚                   â”‚                  â”‚
  â”‚                       â”‚                   â”‚  Check Rules     â”‚
  â”‚                       â”‚                   â”‚  - Multiple      â”‚
  â”‚                       â”‚                   â”‚    attempts?     â”‚
  â”‚                       â”‚                   â”‚  - Critical      â”‚
  â”‚                       â”‚                   â”‚    endpoint?     â”‚
  â”‚                       â”‚                   â”‚                  â”‚
  â”‚                       â”‚                   â”‚  Trigger Alert   â”‚
  â”‚                       â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚                   â”‚  Send to:        â”‚
  â”‚                       â”‚                   â”‚  - Security team â”‚
  â”‚                       â”‚                   â”‚  - Slack/Email   â”‚
  â”‚                       â”‚                   â”‚                  â”‚
  â”‚  403 Forbidden        â”‚                   â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                  â”‚
  â”‚                       â”‚                   â”‚                  â”‚
```

## Key Protection Layers

1. **Authorization Header Pattern** (Current)
   - Malicious sites cannot set Authorization header on cross-origin requests
   - Natural CSRF protection

2. **Origin Validation** (Recommended Add-on)
   - Check Origin/Referer headers
   - Whitelist allowed domains

3. **SameSite Cookies** (If switching to cookies)
   - Prevent cookies from being sent cross-site
   - Strict or Lax mode

4. **CSRF Tokens** (If switching to cookies)
   - Double-submit pattern
   - Stateful token validation

5. **Security Headers**
   - X-Frame-Options: Prevent clickjacking
   - Content-Security-Policy: Restrict resource loading

## References

- design-8-security-csrf.md - Full design document
- OWASP CSRF: https://owasp.org/www-community/attacks/csrf
