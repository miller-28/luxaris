# SQL Injection Protection Flow

## Overview
This document describes the data flow and protection mechanisms against SQL injection attacks in the Luxaris API.

## Attack Scenario Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SQL Injection Attack                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Attacker                 API Gateway          Handler             Repository           Database
   â”‚                         â”‚                    â”‚                   â”‚                    â”‚
   â”‚  POST /api/v1/posts     â”‚                    â”‚                   â”‚                    â”‚
   â”‚  { title: "'; DROP..."}â”‚                    â”‚                   â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                    â”‚
   â”‚                         â”‚  JWT Validation    â”‚                   â”‚                    â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                    â”‚
   â”‚                         â”‚     âœ… Valid       â”‚                   â”‚                    â”‚
   â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                    â”‚
   â”‚                         â”‚  Route to Handler  â”‚                   â”‚                    â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚                    â”‚
   â”‚                         â”‚                    â”‚  Input Validation â”‚                    â”‚
   â”‚                         â”‚                    â”‚  (Schema Check)   â”‚                    â”‚
   â”‚                         â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                         â”‚                    â”‚      âœ… Valid     â”‚                    â”‚
   â”‚                         â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚                         â”‚                    â”‚  Call Service     â”‚                    â”‚
   â”‚                         â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                         â”‚                    â”‚                   â”‚  Parameterized    â”‚
   â”‚                         â”‚                    â”‚                   â”‚  Query Execution  â”‚
   â”‚                         â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                         â”‚                    â”‚                   â”‚  INSERT INTO      â”‚
   â”‚                         â”‚                    â”‚                   â”‚  posts (title)    â”‚
   â”‚                         â”‚                    â”‚                   â”‚  VALUES ($1)      â”‚
   â”‚                         â”‚                    â”‚                   â”‚  ["'; DROP..."]   â”‚
   â”‚                         â”‚                    â”‚                   â”‚                    â”‚
   â”‚                         â”‚                    â”‚                   â”‚  ğŸ›¡ï¸ SAFE: Treated â”‚
   â”‚                         â”‚                    â”‚                   â”‚     as string      â”‚
   â”‚                         â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚                    â”‚                   â”‚  âœ… Success       â”‚
   â”‚                         â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                    â”‚
   â”‚  201 Created            â”‚                    â”‚                   â”‚                    â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚                    â”‚
   â”‚  { id: "123",           â”‚                    â”‚                   â”‚                    â”‚
   â”‚    title: "'; DROP..."}â”‚                    â”‚                   â”‚                    â”‚
   â”‚                         â”‚                    â”‚                   â”‚                    â”‚
```

## Protection Flow: Parameterized Queries

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Parameterized Query Flow                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client                  Handler              Service              Repository           Database
  â”‚                       â”‚                     â”‚                     â”‚                    â”‚
  â”‚  GET /posts?status=X  â”‚                     â”‚                     â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                     â”‚                    â”‚
  â”‚                       â”‚  Validate Status    â”‚                     â”‚                    â”‚
  â”‚                       â”‚  (Enum Check)       â”‚                     â”‚                    â”‚
  â”‚                       â”‚  âœ… Valid           â”‚                     â”‚                    â”‚
  â”‚                       â”‚                     â”‚                     â”‚                    â”‚
  â”‚                       â”‚  Call Service       â”‚                     â”‚                    â”‚
  â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                    â”‚
  â”‚                       â”‚                     â”‚  Call Repository    â”‚                    â”‚
  â”‚                       â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
  â”‚                       â”‚                     â”‚                     â”‚  Build Query       â”‚
  â”‚                       â”‚                     â”‚                     â”‚  const query =     â”‚
  â”‚                       â”‚                     â”‚                     â”‚    "SELECT * FROM  â”‚
  â”‚                       â”‚                     â”‚                     â”‚     posts WHERE    â”‚
  â”‚                       â”‚                     â”‚                     â”‚     status = $1"   â”‚
  â”‚                       â”‚                     â”‚                     â”‚                    â”‚
  â”‚                       â”‚                     â”‚                     â”‚  Execute with Paramsâ”‚
  â”‚                       â”‚                     â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚                     â”‚                     â”‚  query, ["active"] â”‚
  â”‚                       â”‚                     â”‚                     â”‚                    â”‚
  â”‚                       â”‚                     â”‚                     â”‚  PostgreSQL:       â”‚
  â”‚                       â”‚                     â”‚                     â”‚  1. Parse query    â”‚
  â”‚                       â”‚                     â”‚                     â”‚  2. Bind param     â”‚
  â”‚                       â”‚                     â”‚                     â”‚  3. Execute safely â”‚
  â”‚                       â”‚                     â”‚                     â”‚                    â”‚
  â”‚                       â”‚                     â”‚                     â”‚  Result Set        â”‚
  â”‚                       â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                       â”‚                     â”‚  Return Data        â”‚                    â”‚
  â”‚                       â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
  â”‚                       â”‚  Return Data        â”‚                     â”‚                    â”‚
  â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                    â”‚
  â”‚  200 OK               â”‚                     â”‚                     â”‚                    â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                     â”‚                    â”‚
  â”‚  [{ id: 1, ... }]     â”‚                     â”‚                     â”‚                    â”‚
  â”‚                       â”‚                     â”‚                     â”‚                    â”‚
```

## Vulnerable Flow (NEVER DO THIS)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              âŒ VULNERABLE: String Concatenation                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client                  Repository                                 Database
  â”‚                       â”‚                                           â”‚
  â”‚  GET /posts?id=1      â”‚                                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                           â”‚
  â”‚                       â”‚  âŒ BAD CODE:                             â”‚
  â”‚                       â”‚  const query = "SELECT * FROM posts       â”‚
  â”‚                       â”‚                WHERE id = " + id;         â”‚
  â”‚                       â”‚                                           â”‚
  â”‚                       â”‚  Execute: "SELECT * FROM posts            â”‚
  â”‚                       â”‚           WHERE id = 1 OR 1=1"            â”‚
  â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚                                           â”‚
  â”‚                       â”‚  ğŸš¨ ATTACK: Returns ALL posts             â”‚
  â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Data Breach!         â”‚                                           â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                           â”‚
  â”‚                       â”‚                                           â”‚
```

## Input Validation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Input Validation Layer                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Request                 Validator               Handler              Service
  â”‚                       â”‚                       â”‚                    â”‚
  â”‚  POST /posts          â”‚                       â”‚                    â”‚
  â”‚  { title: "...",      â”‚                       â”‚                    â”‚
  â”‚    status: "invalid"} â”‚                       â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                    â”‚
  â”‚                       â”‚  Schema Validation    â”‚                    â”‚
  â”‚                       â”‚  - Type check         â”‚                    â”‚
  â”‚                       â”‚  - Length check       â”‚                    â”‚
  â”‚                       â”‚  - Enum validation    â”‚                    â”‚
  â”‚                       â”‚  - Required fields    â”‚                    â”‚
  â”‚                       â”‚                       â”‚                    â”‚
  â”‚                       â”‚  âŒ Validation Failed â”‚                    â”‚
  â”‚                       â”‚  "status must be one  â”‚                    â”‚
  â”‚                       â”‚   of: draft, active"  â”‚                    â”‚
  â”‚  400 Bad Request      â”‚                       â”‚                    â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                    â”‚
  â”‚  {                    â”‚                       â”‚                    â”‚
  â”‚    errors: [{         â”‚                       â”‚                    â”‚
  â”‚      error_code: "INVALID_ENUM",              â”‚                    â”‚
  â”‚      error_description: "..."                 â”‚                    â”‚
  â”‚    }]                 â”‚                       â”‚                    â”‚
  â”‚  }                    â”‚                       â”‚                    â”‚
  â”‚                       â”‚                       â”‚                    â”‚
```

## Dynamic Query Building Flow (Safe)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Safe Dynamic Query Construction                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Request                Repository                                   Database
  â”‚                       â”‚                                           â”‚
  â”‚  GET /posts           â”‚                                           â”‚
  â”‚  ?status=active       â”‚                                           â”‚
  â”‚  &sort=created_at     â”‚                                           â”‚
  â”‚  &order=desc          â”‚                                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                           â”‚
  â”‚                       â”‚  Validate Filters                         â”‚
  â”‚                       â”‚  - status: enum check âœ…                  â”‚
  â”‚                       â”‚  - sort: whitelist check âœ…               â”‚
  â”‚                       â”‚  - order: enum check âœ…                   â”‚
  â”‚                       â”‚                                           â”‚
  â”‚                       â”‚  Build Query Components:                  â”‚
  â”‚                       â”‚  base = "SELECT * FROM posts"             â”‚
  â”‚                       â”‚  where = ["status = $1"]                  â”‚
  â”‚                       â”‚  params = ["active"]                      â”‚
  â”‚                       â”‚  order_by = "created_at DESC" (whitelisted)â”‚
  â”‚                       â”‚                                           â”‚
  â”‚                       â”‚  Final Query:                             â”‚
  â”‚                       â”‚  "SELECT * FROM posts                     â”‚
  â”‚                       â”‚   WHERE status = $1                       â”‚
  â”‚                       â”‚   ORDER BY created_at DESC"               â”‚
  â”‚                       â”‚                                           â”‚
  â”‚                       â”‚  Execute Safely                           â”‚
  â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚  (query, ["active"])                      â”‚
  â”‚                       â”‚                                           â”‚
  â”‚                       â”‚  ğŸ›¡ï¸ SAFE: Column names whitelisted        â”‚
  â”‚                       â”‚          Values parameterized             â”‚
  â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  200 OK               â”‚                                           â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                           â”‚
  â”‚                       â”‚                                           â”‚
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Secure Error Handling                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client                  Repository                  Error Handler         Logger
  â”‚                       â”‚                             â”‚                    â”‚
  â”‚  GET /posts/invalid   â”‚                             â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                             â”‚                    â”‚
  â”‚                       â”‚  Execute Query              â”‚                    â”‚
  â”‚                       â”‚  (SQL Error)                â”‚                    â”‚
  â”‚                       â”‚  âŒ Syntax Error            â”‚                    â”‚
  â”‚                       â”‚  "invalid UUID"             â”‚                    â”‚
  â”‚                       â”‚                             â”‚                    â”‚
  â”‚                       â”‚  Catch Error                â”‚                    â”‚
  â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
  â”‚                       â”‚                             â”‚  Log Full Error    â”‚
  â”‚                       â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚                             â”‚  {                 â”‚
  â”‚                       â”‚                             â”‚    query: "...",   â”‚
  â”‚                       â”‚                             â”‚    params: [...],  â”‚
  â”‚                       â”‚                             â”‚    error: "..."    â”‚
  â”‚                       â”‚                             â”‚  }                 â”‚
  â”‚                       â”‚                             â”‚                    â”‚
  â”‚                       â”‚  Generic Error Response     â”‚                    â”‚
  â”‚  500 Internal Error   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚                    â”‚
  â”‚  {                    â”‚                             â”‚                    â”‚
  â”‚    errors: [{         â”‚                             â”‚                    â”‚
  â”‚      error_code: "DATABASE_ERROR",                  â”‚                    â”‚
  â”‚      error_description: "Unable to process request",â”‚                    â”‚
  â”‚      error_severity: "error"                        â”‚                    â”‚
  â”‚    }]                 â”‚                             â”‚                    â”‚
  â”‚  }                    â”‚                             â”‚                    â”‚
  â”‚                       â”‚                             â”‚                    â”‚
  â”‚  ğŸ›¡ï¸ CLIENT: No SQL details exposed                 â”‚                    â”‚
  â”‚  ğŸ“Š SERVER: Full error logged for debugging         â”‚                    â”‚
  â”‚                       â”‚                             â”‚                    â”‚
```

## Database Permission Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Database Permission Isolation                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Application              Database (PostgreSQL)
  â”‚                       â”‚
  â”‚  Connect as:          â”‚
  â”‚  luxaris_api_user     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚  âœ… Permissions:
  â”‚                       â”‚  - SELECT on luxaris.posts
  â”‚                       â”‚  - INSERT on luxaris.posts
  â”‚                       â”‚  - UPDATE on luxaris.posts
  â”‚                       â”‚  - DELETE on luxaris.posts
  â”‚                       â”‚  - SELECT on luxaris.users
  â”‚                       â”‚  
  â”‚                       â”‚  âŒ Denied:
  â”‚                       â”‚  - DROP TABLE
  â”‚                       â”‚  - CREATE TABLE
  â”‚                       â”‚  - ALTER TABLE
  â”‚                       â”‚  - GRANT/REVOKE
  â”‚                       â”‚  - Access to system tables
  â”‚                       â”‚  - Access to other schemas
  â”‚                       â”‚
  â”‚  Even if SQL injection â”‚
  â”‚  bypasses params...    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚ DROP TABLE posts;â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚  âŒ Permission Denied
  â”‚  Error Response       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                       â”‚
  â”‚  ğŸ›¡ï¸ Defense in Depth: Limited DB user permissions
  â”‚                       â”‚
```

## Testing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SQL Injection Test Flow                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Test Suite             API Endpoint            Database
  â”‚                       â”‚                       â”‚
  â”‚  Test: SQL Injection  â”‚                       â”‚
  â”‚  Payloads             â”‚                       â”‚
  â”‚                       â”‚                       â”‚
  â”‚  Payload 1:           â”‚                       â”‚
  â”‚  "1' OR '1'='1"       â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
  â”‚                       â”‚  Parameterized Query  â”‚
  â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚  WHERE id = $1        â”‚
  â”‚                       â”‚  ["1' OR '1'='1"]     â”‚
  â”‚                       â”‚                       â”‚
  â”‚                       â”‚  ğŸ›¡ï¸ Treated as string â”‚
  â”‚                       â”‚     No injection      â”‚
  â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  âœ… Test Passed       â”‚                       â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                       â”‚                       â”‚
  â”‚  Payload 2:           â”‚                       â”‚
  â”‚  "1; DROP TABLE--"    â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
  â”‚                       â”‚  Parameterized Query  â”‚
  â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚  WHERE id = $1        â”‚
  â”‚                       â”‚  ["1; DROP TABLE--"]  â”‚
  â”‚                       â”‚                       â”‚
  â”‚                       â”‚  ğŸ›¡ï¸ Treated as string â”‚
  â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  âœ… Test Passed       â”‚                       â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                       â”‚                       â”‚
  â”‚  All 10 payloads      â”‚                       â”‚
  â”‚  tested safely        â”‚                       â”‚
  â”‚                       â”‚                       â”‚
```

## Key Principles

1. **Parameterized Queries**: Always use `$1, $2, ...` placeholders
2. **Input Validation**: Validate type, format, and enums before queries
3. **Whitelist Column Names**: Never use user input for column/table names directly
4. **Error Sanitization**: Never expose SQL errors to clients
5. **Database Permissions**: Limit application user permissions
6. **Defense in Depth**: Multiple layers of protection

## References

- design-7-security-sql-injection.md - Full design document
- OWASP SQL Injection: https://owasp.org/www-community/attacks/SQL_Injection
